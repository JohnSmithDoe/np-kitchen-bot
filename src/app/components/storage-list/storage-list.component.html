<ion-searchbar [(ngModel)]="searchTerm" (ionInput)="searchTermChange($event)" [debounce]="250"></ion-searchbar>
<ion-toolbar>
  <ion-buttons slot="end">
    <ion-button (click)="setDisplayMode('alphabetical')">A-Z</ion-button>
    <ion-button (click)="setDisplayMode('categories')">Categories</ion-button>
  </ion-buttons>
</ion-toolbar>
<div class="ion-padding storage-list-body">

  @if (mode === 'alphabetical') {
    @if (type === 'simple') {
      <ng-container *ngTemplateOutlet="listSimple"></ng-container>
    } @else {
      <ng-container *ngTemplateOutlet="listComplex"></ng-container>
    }
  } @else {
    <ng-container *ngTemplateOutlet="categoryMode"></ng-container>
  }
</div>

<ng-template #categoryMode>
  @for (category of categories; track category.name) {
    <ion-button class="item-category" (click)="chooseCategory(category)">
      {{ category.name }}
    </ion-button>
  }
</ng-template>

<ng-template #listSimple>
  <ion-list>
    @if (!!header) {
      <ion-list-header>
        {{ header }}
      </ion-list-header>
    }

    @for (item of items; track item.id) {
      <app-storage-item [item]="item" (selectItem)="selectItem.emit(item)"></app-storage-item>
    } @empty {
      <ion-item [button]="true" (click)="createItem.emit(searchTerm ?? undefined)" [color]="'primary'">
        <ion-label>{{ searchTerm }} not found! Click here to create ...</ion-label>
      </ion-item>
    }
  </ion-list>
</ng-template>

<ng-template #listComplex>
  <ion-list #ionList>
    <!-- Casting $event to $any is a temporary fix for this bug https://github.com/ionic-team/ionic-framework/issues/24245 -->
    <ion-reorder-group [disabled]="false" (ionItemReorder)="handleReorder($any($event))">
      @for (item of items; track item.id) {

        <ion-item-sliding (ionDrag)="deleteItemOnDrag($event, item, ionList)">
          <app-storage-item type="extended" [item]="item"
                            (selectItem)="selectItem.emit(item)"
                            (cartItem)="moveItem.emit(item)"
          ></app-storage-item>
          <ion-item-options>
            <ion-item-option color="danger" expandable (click)="deleteItemFromList(ionList, item)">Delete</ion-item-option>
          </ion-item-options>
        </ion-item-sliding>
      } @empty {
        @if (!!searchTerm) {
          <app-storage-item
            header="{{ 'storage.list.notfound.add.temporary' | translate : {value: searchTerm} }}"
            [label]="searchTerm" (selectItem)="addTemporaryItem($event)"
          ></app-storage-item>
          <app-storage-item
            header="{{ 'storage.list.notfound.add.permanent' | translate : {value: searchTerm} }}"
            [label]="searchTerm" (selectItem)="createItem.emit(searchTerm)"
          ></app-storage-item>

          @if (alternatives.length) {
            <ion-list-header color="secondary">
              <ion-label>found in globals</ion-label>
            </ion-list-header>
            @for (alternate of alternatives; track alternate.id) {
              <app-storage-item
                [item]="alternate"
                color="secondary"
                helper="Click here to add this ..."
                (selectItem)="selectItem.emit(alternate)"

              ></app-storage-item>
            }
          }
        } @else {
          <ion-item>
            <ion-label class="ion-text-wrap">
              {{ 'storage.list.empty' | translate }}
            </ion-label>
          </ion-item>
        }

      }
    </ion-reorder-group>
  </ion-list>
</ng-template>
